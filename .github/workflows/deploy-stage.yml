name: Deploy to Stage

on:
  push:
    branches: [main]

jobs:
  # Stage 1: Backend Stage Deployment
  deploy-backend-stage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Build Binary
        working-directory: ./backend
        run: |
          go mod download
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o psychic-homily-stage \
            ./cmd/server

      - name: Setup Stage Infrastructure
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Check if directory exists and try to create without sudo first
            if [ ! -d /opt/psychic-homily-stage ]; then
              # Try without sudo first
              mkdir -p /opt/psychic-homily-stage/{scripts,db/migrations,backups} 2>/dev/null || {
                # If that fails, we need sudo - configure passwordless sudo for deploy user
                echo "Need sudo access to create /opt/psychic-homily-stage"
                echo "Please run on VPS: sudo usermod -aG sudo deploy"
                echo "And add to /etc/sudoers: deploy ALL=(ALL) NOPASSWD: /bin/mkdir, /bin/chown"
                exit 1
              }
            else
              # Directory exists, just ensure subdirectories exist
              mkdir -p /opt/psychic-homily-stage/{scripts,db/migrations,backups}
            fi

      - name: Upload Configuration Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/docker-compose.stage.yml,backend/.env.stage,backend/scripts/deploy-stage.sh,backend/systemd/psychic-homily-stage.service,backend/db/migrations"
          target: "/opt/psychic-homily-stage"
          strip_components: 1

      - name: Setup Stage Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Make scripts executable
            chmod +x /opt/psychic-homily-stage/scripts/deploy-stage.sh

            # Install systemd service if not exists
            if [ ! -f /etc/systemd/system/psychic-homily-stage.service ]; then
              sudo cp /opt/psychic-homily-stage/psychic-homily-stage.service /etc/systemd/system/
              sudo systemctl daemon-reload
              echo "Stage systemd service installed"
            fi

      - name: Clean Previous Binary
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/psychic-homily-stage
            rm -f psychic-homily-stage
            exit 0

      - name: Upload Binary
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/psychic-homily-stage"
          target: "/opt/psychic-homily-stage"

      - name: Deploy with Zero-Downtime
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/psychic-homily-stage
            ./scripts/deploy-stage.sh ${{ github.sha }}

      - name: Wait for Backend Health
        run: |
          echo "‚è≥ Waiting for stage backend to be healthy..."
          sleep 30

      - name: Verify Backend Health
        run: |
          echo "üè• Verifying stage backend health..."
          # Optional: Add actual health check here
          curl -f https://api.psychichomily.com/health || exit 1
          echo "‚úÖ Stage backend deployment completed successfully"

  # Stage 2: Frontend Stage Deployment (only after backend is ready)
  deploy-frontend-stage:
    runs-on: ubuntu-latest
    needs: deploy-backend-stage
    steps:
      - name: Wait for Backend Stabilization
        run: |
          echo "‚è≥ Waiting for stage backend to fully stabilize..."
          sleep 30  # Reduced from 60s since backend already had 30s + deploy time

      - name: Trigger Netlify Stage Build
        run: |
          echo "üöÄ Triggering frontend stage deployment on Netlify..."
          if [ -z "$NETLIFY_STAGE_WEBHOOK" ]; then
            echo "‚ùå NETLIFY_STAGE_WEBHOOK secret not set"
            echo "Please add the Netlify build hook URL to GitHub repository secrets"
            exit 1
          fi

          # Trigger build with commit info for better tracking
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "{\"trigger_title\":\"Stage Deploy - Commit ${{ github.sha }}\", \"trigger_branch\":\"main\"}" \
            "$NETLIFY_STAGE_WEBHOOK")

          http_code=$(echo "$response" | tail -1)
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "‚ùå Netlify webhook failed with HTTP $http_code"
            echo "Response: $response"
            exit 1
          else
            echo "‚úÖ Netlify build triggered successfully"
          fi
        env:
          NETLIFY_STAGE_WEBHOOK: ${{ secrets.NETLIFY_STAGE_WEBHOOK }}

      - name: Wait for Frontend Deployment
        run: |
          echo "‚è≥ Waiting for frontend stage deployment to complete..."
          sleep 90  # Reduced from 120s, adjust based on your build times

      - name: Verify Frontend Deployment
        run: |
          echo "üåê Verifying frontend stage deployment..."
          # Optional: Add actual health check here
          # curl -f https://stage-psychic-homily.netlify.app || exit 1
          echo "‚úÖ Frontend stage deployment completed successfully"

      # Optional: Send notification
      - name: Send Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ Stage deployment completed successfully!"
            echo "üì± Backend: http://your-stage-backend.com"
            echo "üåê Frontend: https://your-stage-frontend.netlify.app"
            # Optional: Send to Slack/Discord/etc
          else
            echo "‚ùå Stage deployment failed"
            # Optional: Send failure notification
          fi
